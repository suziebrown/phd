\documentclass[fleqn]{article}
\usepackage[utf8]{inputenc}
\usepackage[margin=2cm]{geometry}

% maths
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}

% bibliography
\usepackage[round, sort&compress]{natbib}
\usepackage{har2nat}
\bibliographystyle{agsm}

% custom header/footer
\usepackage{fancyhdr}
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt}
\fancyhf{}
\rfoot{\textsf{\thepage}}
\lfoot{\textsf{Suzie Brown}}

% generally useful commands
\newcommand{\E}{\mathbb{E}}
\newcommand{\eqdist}{\overset{d}{=}}
\newcommand{\I}[1]{\mathbb{I}\{#1\}}

% project-specific commands
\newcommand{\F}{\mathcal{F}_{t-1}}
\newcommand{\Mn}{\operatorname{Multinomial}}
\newcommand{\Cat}{\operatorname{Categorical}}
\newcommand{\vt}[2][t]{v_{#1}^{(#2)}}
\newcommand{\wt}[2][t]{w_{#1}^{(#2)}}
\newcommand{\wbar}[2][t]{\bar{w}_{#1}^{(#2)}}

\title{Coupling argument for residual resampling}
\author{Suzie Brown}
\date{\today}

\begin{document}
\maketitle
\thispagestyle{fancy}

Consider a population of $N$ particles at time $t$, having fixed weights $(\wt{1},\dots, \wt{N})$ respectively. These will be the parents, and we consider assigning to them $N$ offspring which will form the next generation. 
Let $(a_1, \dots, a_N)$ denote the vector of parental indices of each child, and $(v_1, \dots, v_N)$ the resulting offspring counts for each parent. That is, $v_i = \sum_{j=1}^N \I{a_j = i} $. We will use a superscript $m$ or $r$ to denote the multinomial or residual schemes respectively.\\

In the case of multinomial resampling, we have the following:
\begin{align*}
& (a_1^m, \dots, a_N^m) \sim \Cat(1:N, \wt{1:N}) \\
& (v_1^m, \dots, v_N^m) \sim \Mn(N, \wt{1:N})
\end{align*}

In residual resampling, the first $k := \sum_{i=1}^N \lfloor N\wt{i} \rfloor$ offspring are assigned deterministically, and the remaining $N-k$ are assigned randomly:
\begin{align*}
& (v_1^r, \dots, v_N^r) \eqdist \Mn(N-k, \wt{1:N}) + \lfloor N \wt{1:N} \rfloor
\end{align*}

This distribution can be achieved by doing multinomial resampling as usual, but then overwriting the parental indices of $k$ offspring (to be chosen at random) with the $k$ deterministic assignments (since the offspring are exchangeable and marginals of the Multinomial/Categorical distribution are Multinomial/Categorical).\\

The probability that a randomly chosen pair of children share the same parent is, with multinomial resampling:
\begin{equation*}
p^m = \sum_{i=1}^N (\wt{i})^2
\end{equation*}
and with residual resampling (by partitioning over the common parent and into the cases of deterministic assignment and random assignment):
\begin{align*}
p^r &= \sum_{i=1}^N  \left[ \frac{N-k}{N} \wt{i} \left( \frac{N-k-1}{N} \wt{i} + \frac{\lfloor N\wt{i}\rfloor}{N}\right) + \frac{\lfloor N\wt{i}\rfloor}{N} \left(\frac{N-k}{N} \wt{i} + \frac{k-1}{k} \frac{\lfloor N\wt{i}\rfloor -1}{N} \right) \right] \\
&= \sum_{i=1}^N \frac{1}{N^2} \left[ \left( \wt{i} (N-k) + \lfloor N\wt{i}\rfloor \right)^2 - (N-k) (\wt{i})^2 - \frac{k-1}{k} \lfloor N\wt{i}\rfloor - \frac{1}{k}  \lfloor N\wt{i}\rfloor^2 \right] \\
&\leq \sum_{i=1}^N \frac{1}{N^2} \left( (N-k) \wt{i} + \lfloor N\wt{i}\rfloor \right)^2
\end{align*}

\bibliography{smc.bib}
\end{document}